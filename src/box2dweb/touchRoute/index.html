<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content=" user-scalable = no"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title></title>
    <style type="text/css">
        html,body {overflow: hidden;}
    </style>
    <link href="../lib/normalize.css" rel="stylesheet"/>
    <script type="text/javascript" src="../lib/Box2dWeb-2.1.a.3.js"></script>
    <script type="text/javascript" src="../lib/Simulation/Simulation.js"></script>
    <script type="text/javascript" src="../lib/audiojs/audio.js"></script>
</head>
<body>
<canvas id="canvas" width="360" height="600"></canvas>
<script type="text/javascript">
    //begin config
    var config = {
        //25次成功
        touchSuccess: 25,
        //游戏时间5s
        gameTime: 5 * 1000,
        //抽奖事件
        onPrize: function () {
//            alert("prize");
        },
        //查看游戏规则
        onGuideLine:function(){
//            alert("guide line");
        },
        //分享
        onShare:function(){
//            alert("share");
        }
    };
    //end config

    var canvas = document.querySelector("#canvas");
    canvas.width=window.innerWidth;
    canvas.height=window.innerHeight;
    var ctx = canvas.getContext("2d");

    var sim, img, shape;

    function initSim() {
        if (sim) sim.stop();
        sim = new Simulation({
            ctx: ctx
        });
    }

    function calPos(x, y) {
        return new b2Vec2(x * Resource.scale.x, y * Resource.scale.y);
    }

    function calSize(width,height){
        return {
            width:width*Resource.scale.x,
            height:height*Resource.scale.y
        };
    }

    function drawBg() {
        sim.setBackground(function () {
            this.drawImage(img[0], 0, 0);
        });
    }

    function drawMask() {
        this.save();
        this.globalAlpha = 0.8;
        this.fillStyle = "black";
        this.fillRect(0, 0, canvas.width, canvas.height);
        this.restore();
    }

    function rightPad(num) {
        if (num < 10) {
            return "0" + num;
        }
        return num;
    }

    function start() {
        initSim();

        drawBg();

        sim.setBackground(function () {
            drawMask.apply(this);
            this.drawImage(img[1], 0, 0);
        });

        sim.start();

        function canvasClick() {
            canvas.removeEventListener("click", canvasClick, false);
            gaming();
        }

        canvas.addEventListener("click", canvasClick, false);
    }

    function gaming() {
        var startTime = Date.now();
        var stopTime = config.gameTime;
        var isMouseDown = false;
        var counter = 0;

        initSim();
        drawBg();
        sim.setBackground(function () {
            this.drawImage(img[2], 0, 0);
            this.drawImage(img[3], 0, 450 * Resource.scale.y);

        });
        sim.addRender(function () {
            if (isMouseDown) {
                //draw touch effect
                this.drawImage(img[5], 0, 445 * Resource.scale.y);
            }
            this.drawImage(img[4], 0, 400 * Resource.scale.y);
        });

        var btnShare = new Thing({
            type: b2Body.b2_staticBody,
            position: calPos(161,952),
            userData: {
                id: "btnShare"
            }
        });
        btnShare.setAsBox(calSize(197,54));
        sim.createThing(btnShare);

        var btnGuideLine = new Thing({
            type: b2Body.b2_staticBody,
            position: calPos(476,952),
            userData: {
                id: "btnGuideLine"
            }
        });
        btnGuideLine.setAsBox(calSize(197,54));
        sim.createThing(btnGuideLine);

        sim.on("running", function () {
            var dur = Date.now() - startTime;
            if (dur >= stopTime) {
                isMouseDown = false;
                sim.stop();
            }
        });
        sim.on("stoped", function () {
            canvas.removeEventListener("mousedown", mouseDown, false);
            canvas.removeEventListener("mouseup", mouseUp, false);
            canvas.removeEventListener("touchstart", mouseDown, false);
            canvas.removeEventListener("touchend", mouseUp, false);
            canvas.removeEventListener("click", canvasClick, false);
            stop(counter);
        });
        sim.start();

        function mouseDown() {
            isMouseDown = true;
        }

        function mouseUp() {
            isMouseDown = false;
            counter++;
        }

        function canvasClick(evt){
            var btn = sim.getBodyAtMouse(evt.clientX, evt.clientY);
            if (btn) {
                var userData = btn.GetUserData();
                if (userData) {
                    var id = userData.id;
                    switch (id) {
                        case "btnGuideLine":
                            config.onGuideLine();
                            break;
                        case "btnShare":
                            config.onShare();
                            break;
                    }
                }
            }
        }

        canvas.addEventListener("mousedown", mouseDown, false);
        canvas.addEventListener("mouseup", mouseUp, false);
        canvas.addEventListener("touchstart", mouseDown, false);
        canvas.addEventListener("touchend", mouseUp, false);
        canvas.addEventListener("click", canvasClick, false);
    }
    function stop(touchCount) {
        initSim();
        drawBg();
        sim.setBackground(function () {
            this.drawImage(img[2], 0, 0);
            this.drawImage(img[3], 0, 450 * Resource.scale.y);
            this.drawImage(img[4], 0, 400 * Resource.scale.y);
            drawMask.apply(this);
            this.drawImage(img[6], 0, 0);
            if (touchCount >= config.touchSuccess) {
                this.drawImage(img[7], 0, 0);
                this.save();
                this.font = "bold " + (20 * Resource.scale.x) + "pt 微软雅黑";
                this.fillStyle = "#2d375b";
                this.fillText("5秒            次，该快就得", 180 * Resource.scale.x, 380 * Resource.scale.y);
                this.fillText("恭喜成功！", 180 * Resource.scale.x, 420 * Resource.scale.y);
                this.restore();
                this.save();
                this.fillStyle = "#ea192c";
                this.font = "bold " + (45 * Resource.scale.x) + "pt 微软雅黑";
                this.fillText(rightPad(touchCount), (180 + 50) * Resource.scale.x, (380 + 10) * Resource.scale.y);
                this.restore();
            }
            else {
                this.drawImage(img[8], 0, 0);
                this.save();
                this.font = "bold " + (20 * Resource.scale.x) + "pt 微软雅黑";
                this.fillStyle = "#2d375b";
                this.fillText("5秒            次，你太慢了！", 250 * Resource.scale.x, 380 * Resource.scale.y);
                this.restore();
                this.save();
                this.fillStyle = "#ea192c";
                this.font = "bold " + (45 * Resource.scale.x) + "pt 微软雅黑";
                this.fillText(rightPad(touchCount), (250 + 50) * Resource.scale.x, (380 + 10) * Resource.scale.y);
                this.restore();
            }
        });

        var btnAgain = new Thing({
            type: b2Body.b2_staticBody,
            position:calPos(210,610),
            userData: {
                id: "btnAgain"
            }
        });
        btnAgain.setAsBox(calSize(190,72));


        var btnPrize = new Thing({
            type: b2Body.b2_staticBody,
            position:calPos(435,610),
            userData: {
                id: "btnPrize"
            }
        });
        btnPrize.setAsBox(calSize(190,72));


        var btnClose = new Thing({
            type: b2Body.b2_staticBody,
            position:calPos(560,102),
            userData: {
                id: "btnClose"
            }
        });
        btnClose.setAsBox(calSize(100,100));

        sim.createThing(btnClose);
        sim.createThing(btnPrize);
        sim.createThing(btnAgain);

        function canvasClick(evt) {
            var btn = sim.getBodyAtMouse(evt.clientX, evt.clientY);
            if (btn) {
                var userData = btn.GetUserData();
                if (userData) {
                    var id = userData.id;
//                    alert(id);
                    switch (id) {
                        case "btnClose":
                            start();
                            break;
                        case "btnPrize":
                            config.onPrize();
                            break;
                        case "btnAgain":
                            gaming();
                            break;
                    }
                    canvas.removeEventListener("click", canvasClick, false);
                }
            }
        }
        canvas.addEventListener("click", canvasClick, false);

        sim.start();
    }

    function resourceReady(images) {
        img = images;
        start();
    }
    Resource.loadImage(["res/images/bg_02.png",
                "res/images/start_bg_02.png",
                "res/images/gaming_bg_02.png",
                "res/images/toute_03.png",
                "res/images/hammer_03.png",
                "res/images/touch_effect_03.png",
                "res/images/stop_bg_02.png",
                "res/images/stop_success_02.png",
                "res/images/stop_faile_02.png"],
            resourceReady, true, {width: canvas.width, height: canvas.height}, {width: 640, height: 1008});
</script>
</body>
</html>