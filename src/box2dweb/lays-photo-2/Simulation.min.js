String.format=function(a,b){var c,d=a;if(b instanceof Array)for(c=0;c<b.length;c++)d=d.replace(new RegExp("\\{"+c+"\\}","g"),b[c]);else for(c=1;c<arguments.length;c++)d=d.replace(new RegExp("\\{"+(c-1)+"\\}","g"),arguments[c]);return d};Object.extend=function(a,b){for(var c in b)a[c]instanceof Object?Object.extend(a[c],b[c]):a[c]=b[c]};Array.each=function(a,b){for(var c=0,d=a.length;c<d;c+=1)b.bind(a[c])()};Number.random=function(a,b){return Math.random()*(b-a)+a};window.b2Vec2=Box2D.Common.Math.b2Vec2;
window.b2Body=Box2D.Dynamics.b2Body;window.b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape;window.b2CircleShape=Box2D.Collision.Shapes.b2CircleShape;window.b2Math=Box2D.Common.Math.b2Math;function IEvent(){this._events={}}IEvent.prototype={on:function(a,b){this._events[a]=b;return this},trigger:function(a,b){this._events[a]&&this._events[a].apply(null,b)}};
function Simulation(a){var b=this;if(!a.ctx)throw"cfg.ctx is not defined";a.gravity||(a.gravity=new b2Vec2(0,10));"undefined"===typeof a.allowSleep&&(a.allowSleep=!0);a.step||(a.step=1/60);a.velocityIterations||(a.velocityIterations=10);a.positionIterations||(a.positionIterations=8);this.setting=a;IEvent.call(this);this._timer=null;this.world=new Box2D.Dynamics.b2World(this.setting.gravity,this.setting.allowSleep);a=new Box2D.Dynamics.b2ContactFilter;a.ShouldCollide=function(a,d){return b._events.ShouldCollide?
b.trigger("ShouldCollide",[a,d]):!0};this.world.SetContactFilter(a);a=new Box2D.Dynamics.b2ContactListener;a.BeginContact=function(a){b.trigger("BeginContact",[a])};this.world.SetContactListener(a);this.dctx=this.startTime=this.camera=null}
Simulation.prototype={run:function(){this.startTime||(this.startTime=Date.now());this.trigger("running",[]);this.world.Step(this.setting.step,this.setting.velocityIterations,this.setting.positionIterations);var a,b;this.camera?(a=this.camera.x,b=this.camera.y):b=a=0;this.setting.ctx.clearRect(a,b,this.setting.ctx.canvas.width,this.setting.ctx.canvas.height);this.dctx&&(this.dctx.clearRect(a,b,this.setting.ctx.canvas.width,this.setting.ctx.canvas.height),this.world.DrawDebugData(),this.dctx.fillText("Debugger",
0,10));this.setting.ctx.save();this.setting.ctx.globalAlpha=.3;this.setting.ctx.strokeStyle="red";this.setting.ctx.strokeRect(a,b,this.setting.ctx.canvas.width,this.setting.ctx.canvas.height);this.setting.ctx.restore();this.trigger("rendering",[this.setting.ctx]);for(a=this.world.GetBodyList();a;){if(b=a.GetUserData())b.trigger("update",[this.setting.ctx,a]),b.trigger("render",[this.setting.ctx,a]);a=a.GetNext()}this.world.ClearForces();0===this.status||2==this.status?(this._timer&&(clearTimeout(this._timer),
this._timer=null),this.trigger("stoped",[this.setting.ctx])):this._timer=setTimeout(this.run.bind(this),1E3*this.setting.step)},start:function(){this.status=1;this.run()},pause:function(){this.status=2},stop:function(){this.status=0},createThing:function(a){a.body=this.world.CreateBody(a.bodyDef);Array.each(a.fixtureDef,function(){a.body.CreateFixture(this)});delete a.bodyDef;delete a.fixtureDef},setCamera:function(a){a.ctx=this.setting.ctx;this.camera=a},getRunDuration:function(){return Date.now()-
this.startTime},getBodyAtMouse:function(a,b){a/=Simulation.SCALE;b/=Simulation.SCALE;var c=new b2Vec2(a,b),d=new Box2D.Collision.b2AABB;d.lowerBound.Set(a-.001,b-.001);d.upperBound.Set(a+.001,b+.001);var e;this.world.QueryAABB(function(a){return a.GetShape().TestPoint(a.GetBody().GetTransform(),c)?(e=a.GetBody(),!1):!0},d);return e},setDebugger:function(a){this.dctx=a;var b=new Box2D.Dynamics.b2DebugDraw;b.SetSprite(a);b.SetAlpha(.5);b.SetFlags(Box2D.Dynamics.b2DebugDraw.e_shapeBit);b.SetDrawScale(Simulation.SCALE);
this.world.SetDebugDraw(b)}};Object.extend(Simulation.prototype,IEvent.prototype);Simulation.SCALE=30;function Camera(){this.x=this.y=0;this.ctx=null;this.minY=this.maxY=this.minX=this.maxX=-1}Object.extend(Camera.prototype,IEvent.prototype);
Camera.prototype.follow=function(a,b,c,d,e){this.maxX=c;this.minX=b;this.maxY=e;this.minY=d;a=a.GetPosition().Copy();var f=a.x*Simulation.SCALE;0<=b&&(b=this.x+b,f<b&&(b-=f,this.ctx.translate(b,0),this.x-=b));0<=c&&(b=this.x+c,f>b&&(b=f-b,this.ctx.translate(-b,0),this.x+=b));c=a.y*Simulation.SCALE;0<=d&&(d=this.y+d,c<d&&(d-=c,this.ctx.translate(0,d),this.y-=d));0<=e&&(d=this.y+e,c>d&&(d=c-d,this.ctx.translate(0,-d),this.y+=d))};
function Thing(a){if(!a)throw"missing argument : bodyDef ";this.bodyDef=Thing.newBodyDef();a&&Object.extend(this.bodyDef,a);this.bodyDef.position.Multiply(1/Simulation.SCALE);this.fixtureDef=[];this.body=null;return this}
Thing.prototype={addFixtureDef:function(a){var b=Thing.newFixtureDef();Object.extend(b,a);a=a.shape;if(a instanceof b2CircleShape){var c=a.GetRadius()/Simulation.SCALE;a.SetRadius(c)}a instanceof b2PolygonShape&&(a=a.GetVertices(),Array.each(a,function(){this.Multiply(1/Simulation.SCALE)}));this.fixtureDef.push(b)},on:function(a,b){this.bodyDef.userData.on(a,b)}};Thing.newBodyDef=function(){var a=new Box2D.Dynamics.b2BodyDef;a.userData=new BodyUserData;return a};
Thing.newFixtureDef=function(){var a=new Box2D.Dynamics.b2FixtureDef;a.density=1;a.restitution=.2;a.friction=.5;a.userData=new FixtureUserData;return a};function ImageThing(a,b){Thing.call(this,a);if(!b)throw"image is not defined";this.on("render",this.render.bind(this));this.image=b;this.hw=b.width/2;this.hh=b.height/2}ImageThing.prototype=new Thing({});
ImageThing.prototype.render=function(a,b){var c=b.GetPosition().Copy();c.Multiply(Simulation.SCALE);var d=b.GetAngle();a.save();a.translate(c.x,c.y);a.rotate(d);a.translate(-c.x,-c.y);a.drawImage(this.image,c.x-this.hw,c.y-this.hh);a.restore()};ImageThing.prototype.setDefaultBox=function(a){var b=new b2PolygonShape;b.SetAsBox(this.hw,this.hh);a=a?Object.extend({shape:b},a):{shape:b};this.addFixtureDef(a)};
function Input(){this.keys=Array(255);window.addEventListener("keydown",this._onKeyDown.bind(this),!1);window.addEventListener("keyup",this._onKeyUp.bind(this),!1);this.clear()}Input.prototype={clear:function(){for(var a=0;255>a;a++)this.keys[a]=!1},isKeyDown:function(a){return this.keys[a]},_onKeyDown:function(a){this.keys[a.keyCode]=!0},_onKeyUp:function(a){this.keys[a.keyCode]=!1}};Input.w=87;Input.s=83;Input.a=65;Input.d=68;Input.j=74;Input.k=75;function UserData(){}UserData.prototype={};
function BodyUserData(){UserData.call(this);IEvent.call(this);this.destroy=!1}BodyUserData.prototype=new UserData;Object.extend(BodyUserData.prototype,IEvent.prototype);function FixtureUserData(){UserData.call(this);this.type=this.layer=0}FixtureUserData.prototype=new UserData;FixtureUserData.prototype.setLayer=function(a){this.layer=a};FixtureUserData.prototype.setType=function(a){this.type=a};function Resource(){}Resource.scale={x:1,y:1};
Resource.load=function(a,b,c,d,e,f){function t(){this.removeEventListener("load",t);m++;f&&f(m,h);if(m===h&&b){if(c){if("undefined"===typeof d)throw"canvasSize is not defined";if("undefined"===typeof e)throw"targetSize is not defined";var a,n,k=d.width/e.width,l=d.height/e.height;Resource.scale={x:k,y:l};for(var p=0,r=g.images.length,q;p<r;p++)q=g.images[p],a=document.createElement("canvas"),a.width=q.width*k,a.height=q.height*l,n=a.getContext("2d"),n.save(),n.scale(k,l),n.drawImage(q,0,0),n.restore(),
g.images[p]=a}b(g)}}function r(){this.removeEventListener("canplay",r);m++;f&&f(m,h);m===h&&b&&b(g)}var h=0,m=0,g={};if(a.images){h+=a.images.length;g.images=[];var k;Array.each(a.images,function(){k=document.createElement("img");k.addEventListener("load",t);k.src=this;g.images.push(k)})}if(a.audioes){h+=a.audioes.length;g.audioes=[];var l;Array.each(a.audioes,function(){l=document.createElement("audio");l.addEventListener("canplay",r);l.src=this;g.audioes.push(l)})}};
