function IEvent(){this._events={}}function Simulation(e){var t=this;if(!e.ctx)throw"cfg.ctx is not defined";if(!e.gravity)e.gravity=new b2Vec2(0,10);if(typeof e.allowSleep==="undefined")e.allowSleep=true;if(!e.step)e.step=1/60;if(!e.velocityIterations)e.velocityIterations=10;if(!e.positionIterations)e.positionIterations=8;this.setting=e;IEvent.call(this);this._timer=null;this.world=new Box2D.Dynamics.b2World(this.setting.gravity,this.setting.allowSleep);var n=new Box2D.Dynamics.b2ContactFilter;n.ShouldCollide=function(e,n){if(t._events["ShouldCollide"])return t.trigger("ShouldCollide",[e,n]);else return true};this.world.SetContactFilter(n);var r=new Box2D.Dynamics.b2ContactListener;r.BeginContact=function(e){t.trigger("BeginContact",[e])};this.world.SetContactListener(r);this.camera=null;this.startTime=null;this.debugger=null}function Camera(){this.y=0;this.x=0;this.ctx=null;this.maxX=-1;this.minX=-1;this.maxY=-1;this.minY=-1}function Thing(e){if(!e)throw"missing argument : bodyDef ";var t=this;this.bodyDef=Thing.newBodyDef();if(e)Object.extend(this.bodyDef,e);this.bodyDef.position.Multiply(1/Simulation.SCALE);this.fixtureDef=[];this.body=null;return this}function ImageThing(e,t){Thing.call(this,e);if(!t)throw"image is not defined";this.on("render",this.render.bind(this));this.image=t;this.hw=t.width/2;this.hh=t.height/2}function Input(){this.keys=new Array(255);window.addEventListener("keydown",this._onKeyDown.bind(this),false);window.addEventListener("keyup",this._onKeyUp.bind(this),false);this.clear()}function UserData(){}function BodyUserData(){UserData.call(this);IEvent.call(this);this.destroy=false}function FixtureUserData(){UserData.call(this);this.layer=0;this.type=0}function Resource(){}String.format=function(e,t){var n;var r=e;if(t instanceof Array){for(n=0;n<t.length;n++){r=r.replace(new RegExp("\\{"+n+"\\}","g"),t[n])}}else{for(n=1;n<arguments.length;n++){r=r.replace(new RegExp("\\{"+(n-1)+"\\}","g"),arguments[n])}}return r};Object.extend=function(e,t){for(var n in t){if(e[n]instanceof Object){Object.extend(e[n],t[n])}else{e[n]=t[n]}}};Array.each=function(e,t){var n=0,r=e.length;for(;n<r;n+=1){t.bind(e[n])()}};Number.random=function(e,t){return Math.random()*(t-e)+e};window["b2Vec2"]=Box2D.Common.Math.b2Vec2;window["b2Body"]=Box2D.Dynamics.b2Body;window["b2PolygonShape"]=Box2D.Collision.Shapes.b2PolygonShape;window["b2CircleShape"]=Box2D.Collision.Shapes.b2CircleShape;window["b2Math"]=Box2D.Common.Math.b2Math;IEvent.prototype={on:function(e,t){this._events[e]=t;return this},trigger:function(e,t){if(this._events[e]){this._events[e].apply(null,t)}}};Simulation.prototype={run:function(){if(!this.startTime){this.startTime=Date.now()}this.trigger("running",[]);this.world.Step(this.setting.step,this.setting.velocityIterations,this.setting.positionIterations);var e,t;if(this.camera){e=this.camera.x;t=this.camera.y}else{e=0,t=0}this.setting.ctx.clearRect(e,t,this.setting.ctx.canvas.width,this.setting.ctx.canvas.height);if(this.debugger){this.debugger.clearRect(e,t,this.setting.ctx.canvas.width,this.setting.ctx.canvas.height);this.world.DrawDebugData();this.debugger.fillText("Debugger",0,10)}this.setting.ctx.save();this.setting.ctx.globalAlpha=.3;this.setting.ctx.strokeStyle="red";this.setting.ctx.strokeRect(e,t,this.setting.ctx.canvas.width,this.setting.ctx.canvas.height);this.setting.ctx.restore();this.trigger("rendering",[this.setting.ctx]);var n=this.world.GetBodyList();var r;while(n){r=n.GetUserData();if(r){r.trigger("update",[this.setting.ctx,n]);r.trigger("render",[this.setting.ctx,n])}n=n.GetNext()}this.world.ClearForces();if(this.status===0||this.status==2){if(this._timer){clearTimeout(this._timer);this._timer=null}this.trigger("stoped",[this.setting.ctx]);return}else{this._timer=setTimeout(this.run.bind(this),1e3*this.setting.step)}},start:function(){this.status=1;this.run()},pause:function(){this.status=2},stop:function(){this.status=0},createThing:function(e){e.body=this.world.CreateBody(e.bodyDef);Array.each(e.fixtureDef,function(){e.body.CreateFixture(this)});delete e.bodyDef;delete e.fixtureDef},setCamera:function(e){e.ctx=this.setting.ctx;this.camera=e},getRunDuration:function(){return Date.now()-this.startTime},getBodyAtMouse:function(e,t){function s(e){var t=e.GetShape();var r=t.TestPoint(e.GetBody().GetTransform(),n);if(r){i=e.GetBody();return false}return true}e/=Simulation.SCALE;t/=Simulation.SCALE;var n=new b2Vec2(e,t);var r=new Box2D.Collision.b2AABB;r.lowerBound.Set(e-.001,t-.001);r.upperBound.Set(e+.001,t+.001);var i;this.world.QueryAABB(s,r);return i},setDebugger:function(e){this.debugger=e;var t=new Box2D.Dynamics.b2DebugDraw;t.SetSprite(e);t.SetAlpha(.5);t.SetFlags(Box2D.Dynamics.b2DebugDraw.e_shapeBit);t.SetDrawScale(Simulation.SCALE);this.world.SetDebugDraw(t)}};Object.extend(Simulation.prototype,IEvent.prototype);Simulation.SCALE=30;Object.extend(Camera.prototype,IEvent.prototype);Camera.prototype.follow=function(e,t,n,r,i){this.maxX=n;this.minX=t;this.maxY=i;this.minY=r;var s=e.GetPosition().Copy();var o=s.x*Simulation.SCALE;var u,a,f,l;if(t>=0){u=this.x+t;if(o<u){a=u-o;this.ctx.translate(a,0);this.x-=a}}if(n>=0){u=this.x+n;if(o>u){a=o-u;this.ctx.translate(-a,0);this.x+=a}}var c=s.y*Simulation.SCALE;if(r>=0){f=this.y+r;if(c<f){l=f-c;this.ctx.translate(0,l);this.y-=l}}if(i>=0){f=this.y+i;if(c>f){l=c-f;this.ctx.translate(0,-l);this.y+=l}}};Thing.prototype={addFixtureDef:function(e){var t=Thing.newFixtureDef();Object.extend(t,e);var n=e.shape;if(n instanceof b2CircleShape){var r=n.GetRadius()/Simulation.SCALE;n.SetRadius(r)}if(n instanceof b2PolygonShape){var i=n.GetVertices();Array.each(i,function(){this.Multiply(1/Simulation.SCALE)})}this.fixtureDef.push(t)},on:function(e,t){this.bodyDef.userData.on(e,t)}};Thing.newBodyDef=function(){var e=new Box2D.Dynamics.b2BodyDef;e.userData=new BodyUserData;return e};Thing.newFixtureDef=function(){var e=new Box2D.Dynamics.b2FixtureDef;e.density=1;e.restitution=.2;e.friction=.5;e.userData=new FixtureUserData;return e};ImageThing.prototype=new Thing({});ImageThing.prototype.render=function(e,t){var n=t.GetPosition().Copy();n.Multiply(Simulation.SCALE);var r=t.GetAngle();e.save();e.translate(n.x,n.y);e.rotate(r);e.translate(-n.x,-n.y);e.drawImage(this.image,n.x-this.hw,n.y-this.hh);e.restore()};ImageThing.prototype.setDefaultBox=function(e){var t=new b2PolygonShape;t.SetAsBox(this.hw,this.hh);if(e)e=Object.extend({shape:t},e);else e={shape:t};this.addFixtureDef(e)};Input.prototype={clear:function(){for(var e=0;e<255;e++){this.keys[e]=false}},isKeyDown:function(e){return this.keys[e]},_onKeyDown:function(e){this.keys[e.keyCode]=true},_onKeyUp:function(e){this.keys[e.keyCode]=false}};Input.w=87;Input.s=83;Input.a=65;Input.d=68;Input.j=74;Input.k=75;UserData.prototype={};BodyUserData.prototype=new UserData;Object.extend(BodyUserData.prototype,IEvent.prototype);FixtureUserData.prototype=new UserData;FixtureUserData.prototype.setLayer=function(e){this.layer=e};FixtureUserData.prototype.setType=function(e){this.type=e};Resource.scale={x:1,y:1};Resource.load=function(e,t,n,r,i,s){function f(){if(typeof r==="undefined")throw"canvasSize is not defined";if(typeof i==="undefined")throw"targetSize is not defined";var e,t;var n=r.width/i.width;var s=r.height/i.height;Resource.scale={x:n,y:s};var o=0,u=a.images.length,f;for(;o<u;o++){f=a.images[o];e=document.createElement("canvas");e.width=f.width*n;e.height=f.height*s;t=e.getContext("2d");t.save();t.scale(n,s);t.drawImage(f,0,0);t.restore();a.images[o]=e}}function l(){this.removeEventListener("load",l);u++;if(s)s(u,o);if(u===o&&t){if(n){f()}t(a)}}function c(){this.removeEventListener("canplay",c);u++;if(s)s(u,o);if(u===o&&t)t(a)}var o=0;var u=0;var a={};if(e.images){o+=e.images.length;a.images=[];var h;Array.each(e.images,function(){h=document.createElement("img");h.addEventListener("load",l);h.src=this;a.images.push(h)})}if(e.audioes){o+=e.audioes.length;a.audioes=[];var p;Array.each(e.audioes,function(){p=document.createElement("audio");p.addEventListener("canplay",c);p.src=this;a.audioes.push(p)})}}