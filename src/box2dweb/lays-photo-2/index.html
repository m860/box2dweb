<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content=" user-scalable = no"/>
    <title></title>
    <style type="text/css">
        * {
            padding: 0px;
            margin: 0px;
        }

        body {
            overflow: hidden;
        }
    </style>
    <script type="text/javascript" src="Box2dWeb-2.1.a.3.min.js"></script>
    <script type="text/javascript" src="../lib/Simulation/Simulation.js"></script>
    <script type="text/javascript" src="../lib/Simulation/effect/Effect.js"></script>
    <script type="text/javascript" src="../lib/Simulation/effect/FadeEffect.js"></script>
    <script type="text/javascript" src="../lib/audiojs/audio.js"></script>
</head>
<body>
<canvas id="canvas" width="480" height="800"></canvas>
<script type="text/javascript">
    var canvas = document.querySelector("#canvas")
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    var ctx = canvas.getContext("2d");
    var simulation;
    var res;
    var shape;
    Resource.loadImage(["res/1.jpg",
            "res/2.png",
            "res/3.png",
            "res/4.png",
            "res/5.png",
            "res/6.png",
            "res/7.png",
            "res/8.png",
            "res/9.png",
            "res/10.jpg",
            "res/11.jpg",
            "res/zero.png",//11
            "res/one.png",
            "res/two.png",
            "res/three.png",
            "res/four.png",
            "res/five.png",
            "res/six.png",
            "res/seven.png",
            "res/eight.png",
            "res/nine.png",
            "res/dot.png"//21
            , "res/bg_end.jpg"
            , "res/success.png"
        ], function (result) {
        res = result;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        toReadyPage();
    }, true, {width: canvas.width, height: canvas.height}, {width: 480, height: 800}, function (index, length) {
    });
    function appendAudio(){
        var audio=document.createElement("audio");
        audio.preload="auto";
        var source=document.createElement("source");
        source.src="res/photo.mp3";
        audio.appendChild(source);
        document.body.appendChild(audio);
    }
    appendAudio();
    var music=null;
    audiojs.events.ready(function () {
        music = audiojs.createAll()[0];
        console.log(music!=null);
        document.querySelector(".audiojs").style.display = "none";
    });
    function activateMusic(){
        if(music){
            music.pause();
            document.removeEventListener('touchstart',activateMusic, false);
        }
    }
    document.addEventListener('touchstart',activateMusic, false);
    function playMusic(){
        if(music){
            music.play();
        }
    }
    function drawScore(ctx, score) {
        var left, top = 311 * Resource.scale.y;
        var scoreStr = new String(score);
        var i = 0, len = scoreStr.length;
        left = (window.innerWidth - (len * res[11].width)) / 2;
        var index;
        for (; i < len; i++) {
            if (scoreStr[i] === ".") {
                index = 21;
            }
            else {
                index = parseInt(scoreStr[i]) + 11;
            }
            ctx.drawImage(res[index], left, top);
            left += res[11].width;
        }
    }
    function toReadyPage() {
        simulation = new Simulation({
            ctx: ctx
        });
        function canvasClick() {
            canvas.removeEventListener("click", canvasClick);
            simulation.stop();
            toDescriptionPage();
        }
        canvas.addEventListener("click", canvasClick);
        simulation.setBackground(function () {
            this.drawImage(res[0], 0, 0);
        });
        simulation.addRender(function () {
            this.drawImage(res[1], 180 * Resource.scale.x, 600 * Resource.scale.y);
        }, [new FadeEffect(simulation.setting.ctx,0,1,simulation.setting.step,true)]);
        simulation.start();
    }
    function toDescriptionPage() {
        toGamePage();
    }
    function toGamePage() {
        simulation = new Simulation({
            ctx: ctx,
            gravity: new b2Vec2(0, Number.random(40, 50)),
            step:1/30
        });
        var button = new Thing({
            type: b2Body.b2_staticBody,
            position: new b2Vec2(canvas.width / 2, (canvas.height - res[10].height) + res[10].height / 2),
            userData: {
                id: "button_photo"
            }
        });
        shape = new b2PolygonShape();
        shape.SetAsBox(canvas.width / 2, res[10].height / 2);
        button.addFixtureDef({
            shape: shape,
            restitution: 0
        });
        simulation.createThing(button);
        var photo = new Thing({
            type: b2Body.b2_dynamicBody,
            position: new b2Vec2(canvas.width / 2, 0),
            angle: Number.random(0, Math.PI * 2),
            angularVelocity: Number.random(5, 10),
            userData: {
                id: "body_photo"
            }
        });
        shape = new b2PolygonShape();
        shape.SetAsBox(res[2].width / 2, res[2].height / 2);
        photo.addFixtureDef({
            shape: shape,
            restitution: 0
        });
        simulation.createThing(photo);
        var framePos = new b2Vec2((canvas.width - res[3].width) / 2, (canvas.height - res[10].height - res[3].height) / 2);
        var buttonPos = new b2Vec2(0, canvas.height - res[10].height);
        var isEnd = false;
        function end() {
            simulation.stop();
            canvas.removeEventListener("mousedown", mouseDown);
            function calculateScore() {
                var score = 0;
                var p1 = photo.body.GetPosition().Copy();
                p1.Multiply(Simulation.SCALE);
                var p2 = framePos.Copy();
                p2.x += res[3].width / 2;
                p2.y += res[3].height / 2;
                var disVec = new b2Vec2(p1.x - p2.x, p1.y - p2.y);
                var dis = disVec.Length();
                if (dis <= res[3].height/4) {
                    score = 100;
                }
                else {
                    score = (res[3].height/2 - dis+res[2].height/3) * (100 / (res[3].height/2+res[2].height/3));
                }
                if (score <= 0) score = 0;

                if (score == 100) return score;
                return score.toFixed(2);
            }
            isEnd = true;
            setTimeout(function () {
				toStopPage(calculateScore());
            }, 1000);
        }
        var estep = (canvas.height / 0.2) * simulation.setting.step;
        var eheight = 0;
        var direction = 1;
        function drawPhotoEffect(ctx) {
            if (eheight <= 0 && direction === 0 && !isEnd) {
                end();
            }
            ctx.fillRect(0, 0, canvas.width, eheight);
            ctx.fillRect(0, canvas.height - eheight, canvas.width, eheight);
            if (direction === 1) {
                eheight += estep;
            }
            else {
                eheight -= estep
            }
            if (eheight >= canvas.height / 2) {
                direction = 0;
            }
        }
        simulation.setBackground(function () {
            this.drawImage(res[9], 0, 0);
            this.drawImage(res[10], buttonPos.x, buttonPos.y);
        });
        simulation.addRender(function () {
            var photoPos;
            photoPos = photo.body.GetPosition().Copy();
            photoPos.Multiply(Simulation.SCALE);
            ctx.save();
            ctx.translate(photoPos.x, photoPos.y);
            ctx.rotate(photo.body.GetAngle());
            ctx.translate(-photoPos.x, -photoPos.y);
            ctx.drawImage(res[2], photoPos.x - res[2].width / 2, photoPos.y - res[2].height / 2);
            ctx.restore();
            ctx.save();
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height - res[10].height);
            ctx.restore();
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(framePos.x, framePos.y);
            ctx.lineTo(framePos.x + res[3].width, framePos.y);
            ctx.lineTo(framePos.x + res[3].width, framePos.y + res[3].height);
            ctx.lineTo(framePos.x, framePos.y + res[3].height);
            ctx.closePath();
            ctx.clip();
            ctx.translate(photoPos.x, photoPos.y);
            ctx.rotate(photo.body.GetAngle());
            ctx.translate(-photoPos.x, -photoPos.y);
            ctx.drawImage(res[2], photoPos.x - res[2].width / 2, photoPos.y - res[2].height / 2);
            ctx.restore();
            ctx.drawImage(res[3], framePos.x, framePos.y);
            if (photo.body.GetType() === b2Body.b2_staticBody) {
                drawPhotoEffect(ctx);
            }
        });
        simulation.on("BeginContact", function (contact) {
            var ba = contact.GetFixtureA().GetBody();
            var bb = contact.GetFixtureB().GetBody();
            var ua = ba.GetUserData();
            var ub = bb.GetUserData();
            if (ua && ua.id == "body_photo") {
                playMusic();
                ba.SetType(b2Body.b2_staticBody);
            }
            else if (ub && ub.id == "body_photo") {
                playMusic();
                bb.SetType(b2Body.b2_staticBody);
            }
        });

        function mouseDown(evt) {
            mouseX = evt.clientX;
            mouseY = evt.clientY;
            var mouseBody = simulation.getBodyAtMouse(mouseX, mouseY);
            if (mouseBody) {
                var userData = mouseBody.GetUserData();
                if (userData) {
                    var id = userData.id;
                    if (id === "button_photo") {
                        photo.body.SetType(b2Body.b2_staticBody);
                        playMusic();
                    }
                }
            }
        }
        canvas.addEventListener("mousedown", mouseDown);
        simulation.start();
    }
    function toStopPage(score) {
        simulation = new Simulation({
            ctx: ctx
        });
        var shareButton = new Thing({
            type: b2Body.b2_staticBody,
            position: new b2Vec2(canvas.width / 2,
                    score >= 100 ? ((524 + res[5].height / 2) * Resource.scale.y) : ((524 + res[8].height / 2) * Resource.scale.y))
        });
        shape = new b2PolygonShape();
        if (score >= 100) {
            shape.SetAsBox(res[5].width / 2, res[5].height / 2);
            shareButton.bodyDef.userData.id = "share_success";
        }
        else {
            shape.SetAsBox(res[8].width / 2, res[8].height / 2);
            shareButton.bodyDef.userData.id = "share_fail";
        }
        shareButton.addFixtureDef({
            shape: shape
        });
        simulation.createThing(shareButton);
        var againButton = new Thing({
            type: b2Body.b2_staticBody,
            position: new b2Vec2(canvas.width / 2, (608 + res[6].height / 2) * Resource.scale.y)
        });
        shape = new b2PolygonShape();
        shape.SetAsBox(res[6].width / 2, res[6].height / 2);
        againButton.bodyDef.userData.id = "again";
        againButton.addFixtureDef({
            shape: shape
        });
        simulation.createThing(againButton);
        var buyButton = new Thing({
            type: b2Body.b2_staticBody,
            position: new b2Vec2(canvas.width / 2, (440 + res[7].height / 2) * Resource.scale.y)
        });
        shape = new b2PolygonShape();
        shape.SetAsBox(res[7].width / 2, res[7].height / 2);
        buyButton.bodyDef.userData.id = "buy";
        buyButton.addFixtureDef({
            shape: shape
        });
        simulation.createThing(buyButton);
        simulation.setBackground(function () {
            this.drawImage(res[22], 0, 0);
            drawScore(this, score);
            var pos;
            pos = buyButton.body.GetPosition().Copy();
            pos.Multiply(Simulation.SCALE);
            if (score < 100) {
                this.drawImage(res[7], pos.x - (res[7].width / 2), pos.y - (res[7].height / 2));
            }
            else{
                this.drawImage(res[23], pos.x - (res[23].width / 2), pos.y - (res[23].height / 2));
            }
            pos = shareButton.body.GetPosition().Copy();
            pos.Multiply(Simulation.SCALE);
            if (score >= 100) {
                this.drawImage(res[5], pos.x - (res[5].width / 2), pos.y - (res[5].height / 2));
            }
            else {
                this.drawImage(res[8], pos.x - (res[8].width / 2), pos.y - (res[8].height / 2));
            }
            pos = againButton.body.GetPosition().Copy();
            pos.Multiply(Simulation.SCALE);
            this.drawImage(res[6], pos.x - (res[6].width / 2), pos.y - (res[6].height / 2));
        });

        function mouseDown(evt) {
            mouseX = evt.clientX;
            mouseY = evt.clientY;
            var mouseBody = simulation.getBodyAtMouse(mouseX, mouseY);
            if (mouseBody) {
                var userData = mouseBody.GetUserData();
                if (userData) {
                    var id = userData.id;
                    if (id === "again") {
                        canvas.removeEventListener("mousedown", mouseDown);
                        simulation.stop();
                        toGamePage();
                    }
                    else if (id === "share_success") {
                        simulation.stop();
                        alert("share success");
                    }
                    else if (id === "share_fail") {
                        simulation.stop();
                        alert("share fail");
                    }
                    else if (id === "buy") {
                        window.location.href = "http://auction1.paipai.com/1E31028700000000040100003740F540?ptag=40042.14.12?qq-pf-to=pcqq.c2c";
                    }
                }
            }
        }
        canvas.addEventListener("mousedown", mouseDown);
        simulation.start();
    }
</script>
</body>

</html>